# 提币错误处理改进说明

## 问题描述

用户在尝试提币时遇到以下错误：
```
err_account_not_found: Dry run failed, could not automatically determine a budget: MoveAbort
```

## 根本原因

错误 `err_account_not_found` 表示：
- 用户在Bucket Protocol的储蓄池中**没有账户**
- 用户还**没有进行过任何投资**
- 储蓄池余额为**0 USDB**

**简单来说**：您必须先进行定投（投资到储蓄池），才能进行提币操作。

## 解决方案

### 1. 改进错误提示信息

**修改文件**: `backend/bucket_protocol_service.js` (第469-482行)

添加了更友好的错误提示：

```javascript
// 如果获取储蓄信息失败，可能是用户还没有进行过投资
if (error.message && error.message.includes('account_not_found')) {
  throw new Error('您还没有在储蓄池中进行投资，无法提币。请先进行定投后再尝试提币。');
}

if (!savings || !savings[lpType]) {
  throw new Error('您在储蓄池中没有余额，无法提币。请先进行定投后再尝试提币。');
}
```

### 2. 增加余额检查

**修改文件**: `backend/bucket_protocol_service.js` (第489-501行)

添加了多重余额验证：

```javascript
// 检查余额是否为0
if (lpBalance === 0) {
  throw new Error('您的储蓄池余额为0，无法提币。');
}

// 检查提币金额是否有效
if (withdrawAmount <= 0) {
  throw new Error('提币金额必须大于0');
}
```

## 正确的使用流程

### ✅ 第一步：创建定投计划
1. 登录系统
2. 创建新的定投计划
3. 选择"储蓄池理财"策略
4. 设置定投金额（例如：0.1 USDB）

### ✅ 第二步：执行定投
1. 触发传感器或手动执行定投
2. 等待定投交易成功确认
3. 检查"可用余额"是否增加

### ✅ 第三步：提币
1. 点击"提取资金"按钮
2. 输入提币金额（不超过可用余额）
3. 确认提币操作

## 错误信息对照表

| 错误信息 | 含义 | 解决方法 |
|---------|------|----------|
| `err_account_not_found` | 没有储蓄账户 | 先进行定投操作 |
| `您还没有在储蓄池中进行投资` | 从未投资过 | 创建定投计划并执行定投 |
| `您在储蓄池中没有余额` | 余额为0 | 进行定投后再提币 |
| `您的储蓄池余额为0` | 余额已提取完 | 需要重新定投 |
| `提币金额不能超过可用余额` | 提币金额过大 | 减少提币金额 |

## 前端显示

前端会自动显示后端返回的友好错误信息：
- 错误会显示在提币弹窗的错误提示区域
- 用户可以根据提示调整操作流程
- 无需查看技术错误日志

## 注意事项

⚠️ **重要**：
1. 提币功能**不是**转账功能
2. 提币是从**储蓄池**中提取已投资的资金
3. 如果从未投资过，**无法提币**
4. 提币金额**不能超过**当前储蓄池余额

## 测试建议

### 测试场景1：无余额用户提币
- **预期结果**：显示"您还没有在储蓄池中进行投资，无法提币"
- **操作**：先执行定投，再尝试提币

### 测试场景2：有余额用户提币
- **预期结果**：提币成功，返回交易哈希
- **操作**：输入不超过可用余额的金额

### 测试场景3：超额提币
- **预期结果**：显示"提币金额不能超过可用余额"
- **操作**：调整提币金额至可用余额内

## 完成状态

✅ 添加了储蓄账户检查  
✅ 改进了错误提示信息  
✅ 增加了余额验证逻辑  
✅ 前端自动显示友好错误  
✅ 文档编写完成  

现在用户在提币失败时可以看到清晰的中文提示，了解失败原因和解决方法。
